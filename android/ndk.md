# Android NDK

## Android Studio에서 NDK 사용
### 필요 환경
* Android Studio 1.5 기준
* Android NDK r10e 기준
* Gradle 2.5 기준
* SDK Build Tools 19.0.0 
* Java 1.7

### 참고
* Android studio로 Android NDK 코드 작성하기 http://thdev.net/635
* 안드로이드 스튜디오에서 NDK 로 C++ 빌드하기 (Hello World 예제) http://dev.re.kr/65
* http://tools.android.com/tech-docs/new-build-system/gradle-experimental

### Android Studio 설정
#### gradle-wapper.properties

```
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-2.5-all.zip
```

#### build.gradle (Project)

```
buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle-experimental:0.2.1'

        // NOTE: Do not place your application dependencies here; they belong
        // in the individual module build.gradle files
    }
}

allprojects {
    repositories {
        jcenter()
    }
}
```

#### build.gradle (App)
이 부분이 기존과 많은 변경이 발생한다.

자세한 변경사항은 다음 링크를 참조.

http://tools.android.com/tech-docs/new-build-system/gradle-experimental

```javascript
apply plugin: 'com.android.model.application' 
// com.android.application -> com.android.model.application

model { // android 블록 전체를 model로 감싼다

    android {
        compileSdkVersion = 23
        buildToolsVersion = "22.0.1"

        defaultConfig.with {
            applicationId = "xx.xx.xxxxx"
            minSdkVersion.apiLevel = 19
            targetSdkVersion.apiLevel = 23
            versionCode = 1
            versionName = "1.0"
        }

        allprojects {
            sourceCompatibility = 1.7 // Java 1.7 사용
            targetCompatibility = 1.7  // 이 부분이 없으면 Android Studio에서 Run 때 에러가 발생.
        }
    }

    android.buildTypes {
        release {
            minifyEnabled = false
            proguardFiles.add( file('proguard-rules.txt') )
        }
    }

    android.ndk {
        moduleName = "audiolib" // NDK Module Name
        /*
         * Other ndk flags configurable here are
         * cppFlags += "-fno-rtti"
         * cppFlags += "-fno-exceptions"
         * ldLibs    = ["android", "log"]
         * stl       = "system"
         */

        ldLibs    = [ "log", "android", "GLESv3"]
    }

    android.productFlavors {
        // for detailed abiFilter descriptions, refer to "Supported ABIs" @
        // https://developer.android.com/ndk/guides/abis.html#sa
        create("arm") {
            ndk.abiFilters += "armeabi"
        }
        create("arm7") {
            ndk.abiFilters += "armeabi-v7a"
        }
        create("arm8") {
            ndk.abiFilters += "arm64-v8a"
        }
        create("x86") {
            ndk.abiFilters += "x86"
        }
        create("x86-64") {
            ndk.abiFilters += "x86_64"
        }
        create("mips") {
            ndk.abiFilters += "mips"
        }
        create("mips-64") {
            ndk.abiFilters += "mips64"
        }
        // To include all cpu architectures, leaves abiFilters empty
        create("all")
    }

}

dependencies {
    compile fileTree(dir: 'libs', include: ['*.jar'])
    compile 'com.android.support:appcompat-v7:23.0.1'
}
```

#### JNI
JNI 디렉토리 추가.
java > {app} > main > jni

##### class: Sample

```java
public class ExAudioLib {

    static {
        System.loadLibrary("audiolib"); // NDK Module Name
    }

    private static ExAudioLib __instance;

    public static void init() {
        __instance = new ExAudioLib();
    }

    public static void release() {
        __instance = null;
    }

    public static ExAudioLib getInstance() {
        return __instance;
    }

    public native String testNDK();

}
```

##### header: Sample
직접 작성하기 보단 javah 명령을 이용해서 자동생성하는 것을 권장.
```cpp
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class xx_xxx_xxxx_app_lib_ExAudioLib */

#ifndef _Included_xx_xxx_xxxx_app_lib_ExAudioLib
#define _Included_xx_xxx_xxxx_app_lib_ExAudioLib
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     xx_xxx_xxxx_app_lib_ExAudioLib
 * Method:    testNDK
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_xx_xxx_xxxx_app_lib_ExAudioLib_testNDK(JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

##### cpp: Sample

```cpp
#include "xx_xxx_xxxx_app_lib_ExAudioLib.h"
#include <GLES3/gl3.h>

JNIEXPORT jstring JNICALL Java_xx_xxx_xxxx_app_lib_ExAudioLib_testNDK(JNIEnv *env, jobject) {
    jstring str =  (*env).NewStringUTF("NDK Test OK !!");
    return str;
}
```

#### Build
이제 Android.mk 등의 mk 파일을 만들 필요가 없다. App Gradle 파일의 android.ndk 블록에서 필요한 옵션들을 적용하면 된다. 빌드는 일반 안드로이드 앱 빌드랑 동일하게 진행하면 된다.

#### 편리 기능
##### javah 기능 추가
Android Studio 설정에서, External Tools에 다음 항목을 추가.
- Name: javah
- Group: NDK
- Description: javah // 이 부분은 적당히...
- Options 및 Show in: 모두 체크
- Tool settings
  - Program; /usr/bin/javah
  - Parameters: -classpath $Classpath$ -v -jni $FileClass$
  - Working directory: $SourcepathEntry$/../jni

사용법: Java 클래스 파일을 선택하고, 마우스 오른쪽 메뉴 > NDK > javah 선택.

## JNI types

| Java Type | Native Type | Description |
| --------- | ----------- | ----------- |
| boolean | jboolean | 8 bits, unsigned |
| byte | jbyte | 8 bits, signed|
| char | jchar | 16 bits, unsigned|
| double | jdouble | 64 bits|
| float | jfloat | 32 bits|
| int | jint | 32 bits, signed, 그냥 int로 써도 되긴 함.|
| long| jlong | 64 bits, signed|
| short | jshort | 16 bits, signed|
| void | void | |
