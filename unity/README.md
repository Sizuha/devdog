# Unity

## 버전관리
### 외부 버전 시스템으로 Unity3D 버전 관리하기

1. 메뉴: Edit > Project Settings > Editor > (Inspector 창)
1. 버전 관리 모드 변경: Version Control > Mode > Meta Files
1. 애셋 직렬화 모드 변경: Asset Serialization > Mode > Force Text

### 버전 관리를 하지 않아도 되는 파일 추가하기
다음 내용으로 프로젝트 루트 디렉토리에 **.gitignore** 파일을 생성.
```
# Unity Folders
[Ll]ibrary/
[Tt]emp/
[Oo]bj/

# Autogenerated VS/MD solution and project files
*.csproj
*.unityproj
*.sln
*.suo
*.user
*.userprefs
*.pidb
*.booproj

# Unity3D Generated File On Crash Reports
sysinfo.txt

# Mac
.DS_Store

# Android
*.apk
*.obb

# Etc.
assetDatabase*
guidmapper
.~lock*
*.pyc
*.pyc.meta
```

## 사용법
### Keys

* Q,W,E,R: Hand, Move, Rotate, Resize
* Option(Alt) : 화면 가운데를 기준으로 뷰를 회전.
* Option + Command: Hand
* 마우스 가운데 버튼: Hand
* Command + Shift + B: Build Settings
* Command + B: Build

### 사용하지 않는 Scene 제거: Build Settings에서
지우려는 씬을 클릭해서 선택한 다음, 키보드의 Delete키를 누른다.

## 환경

### Defines
#### 플랫폼
http://docs.unity3d.com/Manual/PlatformDependentCompilation.html

- UNITY_EDITOR
- UNITY_IOS
- UNITY_ANDROID
- UNITY_STANDALONE_OSX
- UNITY_STANDALONE_WIN
- UNITY_WEBPLAYER

#### 코드에서 Define 심볼 리스트 가져오기

```csharp
// 定義されているシンボルを取得します
var defines = EditorUserBuildSettings.activeScriptCompilationDefines;
```

### Runtime에서 확인
#### 동작 모드

- Application.isEditor
- Application.isPlaying

- Debug Build

```csharp
if (Debug.isDebugBuild) {
    Debug.Log("Yay!");
}
else {
    Debug.Log("Booo...");
}
```

#### 플랫폼
플랫폼 확인은 Application.platform 활용.
```csharp
public static string getOSName() {
  switch (Application.platform) {
    case RuntimePlatform.Android:
      return "android";

    case RuntimePlatform.IPhonePlayer:
      return "ios";

    default:
      return "other";
  }
}
```

#### 시스템 언어
Application.systemLanguage 필드를 참조한다.
```csharp
if (Application.systemLanguage == SystemLanguage.Korean) {
  // TODO ...
}
```

### Garbage Collection
쓰레기 수집 지시
```csharp
System.GC.Collect();
```

### 플랫폼별 버전 확인
#### Editor 모드에서 확인

```csharp
// Android
int verCode = UnityEditor.PlayerSettings.Android.bundleVersionCode;

// 기타.
string ver = UnityEditor.PlayerSettings.bundleVersion;

// iOS에서 OS 및 sdk 버전 확인
// UnityEditor.PlayerSettings.iOS 참조.
```

#### Runtime에서 확인
런타임에서는 UnityEditor 네임스페이스에 접근이 불가능 하다. 가장 확실한 방법은 네이티브 플러그인에서 구현하는 것.

그래도, 유니티 코드만 가지고서 버전 정보를 알아야 될 필요가 있다면 다음 코드가 유용할 듯.
```csharp
/* Assets/Editor/ 경로에 위치시킬 것. */

using UnityEngine;
using UnityEditor;
using System.IO;

[InitializeOnLoad]
public class BundleVersionChecker
{
  /// <summary>
  /// Class name to use when referencing from code.
  /// </summary>
  const string ClassName = "CurrentBundleVersion";
  
  const string TargetCodeFile = "Assets/Scripts/Config/" + ClassName + ".cs";
  
  static BundleVersionChecker () {
    string bundleVersion = PlayerSettings.bundleVersion;
    string lastVersion = CurrentBundleVersion.version;
    if (lastVersion != bundleVersion) {
      Debug.Log ("Found new bundle version " + bundleVersion + " replacing code from previous version " + lastVersion +" in file \"" + TargetCodeFile + "\"");
      CreateNewBuildVersionClassFile (bundleVersion);
    }
  }
  
  static string CreateNewBuildVersionClassFile (string bundleVersion) {
    using (StreamWriter writer = new StreamWriter (TargetCodeFile, false)) {
      try {
        string code = GenerateCode (bundleVersion);
        writer.WriteLine ("{0}", code);
      } catch (System.Exception ex) {
        string msg = " threw:\n" + ex.ToString ();
        Debug.LogError (msg);
        EditorUtility.DisplayDialog ("Error when trying to regenerate class", msg, "OK");
      }
    }
    return TargetCodeFile;
  }
  
  /// <summary>
  /// Regenerates (and replaces) the code for ClassName with new bundle version id.
  /// </summary>
  /// <returns>
  /// Code to write to file.
  /// </returns>
  /// <param name='bundleVersion'>
  /// New bundle version.
  /// </param>
  static string GenerateCode (string bundleVersion) {
    string code = "public static class " + ClassName + "\n{\n";
    code += System.String.Format ("\tpublic static readonly string version = \"{0}\";", bundleVersion);
    code += "\n}\n";
    return code;
  }
}
```

### 디바이스 고유 ID

```csharp
SystemInfo.deviceUniqueIdentifier
```

## Unity Project 구조
### 프로젝트 디렉토리 구성

참조: http://tsubakit1.hateblo.jp/entry/20131028/1382965930

### Assets
유니티 프로젝트에서 참조되는 모든 어셋 자원들이 이곳에 들어간다.

Assets 디렉토리 하위에 다음과 같은 특별한 디렉토리를 둘 수 있다.

- Resources : 게임에서 동적으로 참조 가능한 리소스들. 패키지 빌드 시에 반드시 빌드에 함께 포함된다.
- Editor : 유니티 에디터 상에서만 적용되고, 실제 빌드에는 포함되지 않는다. 주로 에디터용 확장 플러그인들.
- Plugins : 말그대로 플러그인용 코드 혹은 라이브러리(DLL 등)들이 위치하는 곳. 각 플랫폼별로 적용하기 위해 아래와 같은 하위 디렉토리를 만들어 둘 수 있다.
  - Android
  - iOS
- StreamingAssets : 게임 내에서 OS상의 파일 경로를 통해 참조 가능한 리소스들이 위치하는 곳. 당연히 빌드 패키지에 포함된다. Resources 디렉토리와 다른 점은 패키지 안에서 번들로 묶이지 않고, 각각이 개별 파일로 분리되어 들어가게 된다는 것. 다만 기본적으로 Read Only 이다.

#### 빌드 후 패키지에 포함되는 요소들
유니티 프로젝트에서 사용되는 모든 어셋이 포함되서 빌드되는 것은 아니다.

1. 우선 Assets 디렉토리 이하의 내용물들이 패키징 대상들이다.
1. 런타임 때 참조 할 가능성이 있는 어셋들은 무조건 패키징에 포함된다.
   1. Resources 라는 이름으로된 디렉토리 이하의 내용물은 무조건 패키징 된다.
   1. StreamingAssets도 마찬가지.
1. 동적으로 참조되지 않는 리소스(그래픽, 사운드 등) 중에, 실제로 어디에서도 사용된 적이 없으면 패키징에는 포함되지 않는다.
   1. 최적화 옵션이 켜 있는 경우에만 해당하는 듯.
1. Editor 라는 이름으로 된 디렉토리 이하의 내용물은 기본적으로 패키징 되지 않는다. 다만 다음과 같은 예외가 있다.
   1. Resources 디렉토리 이하에 Editor라는 디렉토리가 있는 경우는 제외.
   1. 어딘가에서 정적으로 참조되고 있는 리소스가 있다면, Editor 디렉토리 안에 들어있어도 당연히 패키징에 포함된다.

이 규칙들을 잘 활용하면, 빌드 후 패키지의 용량을 잘 컨트롤 할 수 있다.

## Script

[Unity Script](unity_script.md) 참조.

## 게임 개발
* [Unity 게임개발](unity_game_dev.md)  참조.
* [Unity 2D게임](unity_2dgame_dev.md)  참조.

## 플랫폼 연동
[Unity 플랫폼 연동](unity_inter_platform.md) 참조.

## Build

### 빌드 자동화
[Unity 빌드 자동화](unity_build.md) 참조.

### Asset Bundle
어셋 번들 사용 방법은 [Unity Asset Bundle](unity_asset_bundle.md) 참조.

## 삽질

### Code Strip 옵션에서 주의사항
Code Stripping 시에 C#에서 제공하는 Security관련 라이브러리들이 제대로 동작을 안 할 수도 있다.<br />
Security 관련 기능을 사용할 때 문제가 생기면, Stripping 옵션을 한번 꺼 볼 것.

### Jar 리소스 문제
AdFresca 등의 jar 라이브러리를 포함해서 사용할 때, 이들 라이브러리에서 jar에 asset 리소스가 포함되어 있는 경우가 있다.

이때는 반드시 jar 압축을 풀어서 관련 리소스를 유니티 프로젝트 Plugins/Android/assets 경로에 복사해야 함.

※ jar 대신 aar 사용을 권함.

### InvalidOperationException: Operation is not valid due to the current state of the object

1. Layout 메뉴에서 레이아웃을 디폴트로 설정.
1. Layout 메뉴에서 레이아웃 공장 초기화 진행.
1. Unity 재시작
